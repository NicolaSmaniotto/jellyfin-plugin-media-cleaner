<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Media Cleaner</title>
</head>
<body>
    <div id="MediaCleanerConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="MediaCleanerConfigForm">
                    <h2>Movies</h2>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="KeepMoviesFor">Keep for</label>
                        <input id="KeepMoviesFor" name="KeepMoviesFor" type="number" is="emby-input" min="-1" />
                        <div class="fieldDescription">How many days to keep a played movie before deleting. -1 to disable</div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="KeepFavoriteMovies">Keep favorites</label>
                        <select is="emby-select" id="KeepFavoriteMovies" name="KeepFavoriteMovies" class="emby-select-withcolor emby-select">
                            <option value="DontKeep">No</option>
                            <option value="AnyUser">Any user</option>
                            <option value="AllUsers">All users</option>
                        </select>
                        <div class="fieldDescription"></div>
                    </div>

                    <h2>Series</h2>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="KeepEpisodesFor">Keep episodes for</label>
                        <input id="KeepEpisodesFor" name="KeepEpisodesFor" type="number" is="emby-input" min="-1" />
                        <div class="fieldDescription">How many days to keep a played episode before deleting. -1 to disable</div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="DeleteEpisodes">Delete after played</label>
                        <select is="emby-select" id="DeleteEpisodes" name="DeleteEpisodes" class="emby-select-withcolor emby-select">
                            <option value="Episode">Episode</option>
                            <option value="Season">Entire season</option>
                            <option value="Series">Entire series</option>
                        </select>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="KeepFavoriteEpisodes">Keep favorites</label>
                        <select is="emby-select" id="KeepFavoriteEpisodes" name="KeepFavoriteEpisodes" class="emby-select-withcolor emby-select">
                            <option value="DontKeep">No</option>
                            <option value="AnyUser">Any user</option>
                            <option value="AllUsers">All users</option>
                        </select>
                        <div class="fieldDescription"></div>
                    </div>

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>${Save}</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var MediaCleanerConfig = {
                pluginUniqueId: '607fee77-97eb-41fe-bf22-26844d99ffb0'
            }

            document.querySelector('#MediaCleanerConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg()

                    const $KeepFavoriteMovies = document.querySelector('#KeepFavoriteMovies')
                    const $KeepFavoriteEpisodes = document.querySelector('#KeepFavoriteEpisodes')
                    $KeepFavoriteMovies.addEventListener('change', keepFavoriteChanged)
                    $KeepFavoriteEpisodes.addEventListener('change', keepFavoriteChanged)

                    ApiClient.getPluginConfiguration(MediaCleanerConfig.pluginUniqueId).then(config => {
                        document.querySelector('#KeepMoviesFor').value = config.KeepMoviesFor
                        document.querySelector('#KeepFavoriteMovies').value = config.KeepFavoriteMovies
                        document.querySelector('#KeepEpisodesFor').value = config.KeepEpisodesFor
                        document.querySelector('#DeleteEpisodes').value = config.DeleteEpisodes
                        document.querySelector('#KeepFavoriteEpisodes').value = config.KeepFavoriteEpisodes

                        fireChange([$KeepFavoriteMovies, $KeepFavoriteEpisodes])

                        Dashboard.hideLoadingMsg()
                    });
                })
            
            document.querySelector('#MediaCleanerConfigForm')
                .addEventListener('submit', (e) => {
                Dashboard.showLoadingMsg()
                ApiClient.getPluginConfiguration(MediaCleanerConfig.pluginUniqueId).then(config => {
                    config.KeepMoviesFor = document.querySelector('#KeepMoviesFor').value
                    config.KeepFavoriteMovies = document.querySelector('#KeepFavoriteMovies').value
                    config.KeepEpisodesFor = document.querySelector('#KeepEpisodesFor').value
                    config.DeleteEpisodes = document.querySelector('#DeleteEpisodes').value
                    config.KeepFavoriteEpisodes = document.querySelector('#KeepFavoriteEpisodes').value
                    ApiClient.updatePluginConfiguration(MediaCleanerConfig.pluginUniqueId, config).then(result => {
                        Dashboard.processPluginConfigurationUpdateResult(result)
                    })
                })

                e.preventDefault()
                return false
            })

            function keepFavoriteChanged(event) {
                const field = this.parentNode.querySelector('.fieldDescription')
                switch (this.value) {
                    case 'AnyUser':
                        field.innerHTML = 'At least one user have item in favorites'
                        break

                    case 'AllUsers':
                        field.innerHTML = 'All users have item in favorites'
                        break

                    default:
                        field.innerHTML = ''
                }
            }

            function fireChange(elements) {
                elements = Array.isArray(elements) ? elements : [elements]
                elements.forEach(x => x.dispatchEvent(new Event('change')))
            }
        </script>
    </div>
</body>
</html>
